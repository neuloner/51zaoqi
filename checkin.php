<?phprequire_once('lib/db.php');require_once('lib/util.php');require_once('users.php');require_once('weboshare/update51zaoqi2weibo.php');Class CheckIn {    private $_objDb;    private $_objUtil;    private $_objUsers;    public function __construct() {        $this->_objDb = new Db();        $this->_objUtil = new Util();        $this->_objUsers = new Users();    }    public function hasBeenChecked($wxId) {        $today = date('y-m-j');        $sql = "select ciid,isontime from checkin where wxid='$wxId' and cidate = '$today'";        $res = $this->_objDb->query($sql);        $row = mysqli_fetch_row($res);        if(count($row) > 0)            return array(                'result' => true,               'isOnTime' => $row[1],            );        else             return array(                'result' => false,            );    }    public function checkIn($wxId) {        $result = array();        $userId = $this->_objUtil->getUserId($wxId);        sae_debug('[checkin]'.$userId);        $time = time();        $today = date('y-m-j');        $role = $this->_objUtil->getUserRole($wxId);        sae_debug('[checkin]'.$role);        //rank        $sql = "select username from checkin,users where checkin.userid=users.id and             cidate ='$today' and role = $role order by citime";        sae_debug('[checkin]'.$sql);        $res = $this->_objDb->query($sql);        if( $res === false) {            throw new exception();        }        $frontUsers = array();        while ($row = mysqli_fetch_row($res)) {            $frontUsers[] = $row[0];        }        if(!empty($frontUsers)) {            $result['frontUsers'] = $frontUsers;        }        $result['rank'] = count($frontUsers) + 1;        //if contime        $isOnTime = 0;        if($this->isOnTime($role,$time))           $isOnTime = 1;         //counter                //check if continuous        $week_num = date('N');//        if($week_num == 1)             $yesterday_time = $time - 24*60*60;        /*        else            $yesterday_time = $time - 24*60*60;        */        $yesterday = date('y-m-j',$yesterday_time);        $sql = "select userid from checkin where cidate = '$yesterday' and userid=$userId and isontime=1";        $res = $this->_objDb->query($sql);        $row = mysqli_fetch_row($res);        if(count($row) > 0)            $continuous = 1;        else            $continuous = 0;        //判断是否是连续的         if($continuous == 0) {            $sql = "select counter,maxcounter from usercheckcount where userid=$userId";            $res = $this->_objDb->query($sql);            $row = mysqli_fetch_row($res);            $counter = $row[0];            $maxCounter = $row[1];            if($maxCounter < $counter) {                $sql = "update usercheckcount set maxcounter=$counter where userid=$userId";                $res = $this->_objDb->query($sql);            }            $sql = "update usercheckcount set counter=0 where userid=$userId";             $res = $this->_objDb->query($sql);        }                if($isOnTime) {  //如果及时而且此次连续            $sql = "select counter,maxcounter from usercheckcount where userid=$userId";            $res = $this->_objDb->query($sql);            $row = mysqli_fetch_row($res);            $continuousNum = $row[0] + 1;            $maxCounter = $row[1];            if($maxCounter < $continuousNum) {                $sql = "update usercheckcount set maxcounter=$continuousNum where userid=$userId";                $res = $this->_objDb->query($sql);            }            $sql = "update usercheckcount set counter=$continuousNum where userid=$userId";             $res = $this->_objDb->query($sql);        } else {            $sql = "select counter,maxcounter from usercheckcount where userid=$userId";            $res = $this->_objDb->query($sql);            $row = mysqli_fetch_row($res);            $counter = $row[0];            $maxCounter = $row[1];            if($maxCounter < $counter) {                $sql = "update usercheckcount set maxcounter=$counter where userid=$userId";                $res = $this->_objDb->query($sql);            }            $sql = "update usercheckcount set counter=0 where userid=$userId";             $res = $this->_objDb->query($sql);            $continuousNum = 0;         }        $result['counter'] = $continuousNum;        $result['isOnTime'] = $isOnTime;        //check in        $sql = "insert into checkin (userid,wxid,citime,cidate,role,isontime)                 values ($userId,'$wxId',$time,'$today',$role,$isOnTime)";        $res = $this->_objDb->query($sql);        if($res === false) {            throw new exception();        }        return $result;    }     public function getDefeatRes($rank,$role) {         switch($role) {        case 1:            $total = count($this->_objUsers->getSixUsersId());            break;        case 2:            $total = count($this->_objUsers->getSevenUsersId());            break;        }        sae_debug($total);        sae_debug($rank);        $res = round((($total-$rank) / $total),2);        sae_debug($res);        return ($res*100).'%';    }    public function getMaxCheckCounter($uid) {        $sql = "select maxcounter from usercheckcount where userid=$uid";        $res = $this->_objDb->query($sql);        $row = mysqli_fetch_row($res);        return $row[0];    }    public function isOnTime($role,$time) {        $hour = date('H',$time);          $min = date('i',$time);        if($role == 1) {            if(($hour <= 5 && $hour >= 3) || ($hour == 6 && $min <= 30)) {                return true;            }        } else if ($role == 2) {            if(($hour <= 6 && $hour >= 3) || ($hour == 7 && $min <= 30)) {                return true;            }        }        return false;    }    }